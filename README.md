# Утилита очистки временных файлов (v2.1)

## Назначение
PowerShell-скрипт для автоматической очистки временных файлов на локальных и удаленных компьютерах Windows. Удаляет устаревшие файлы (старше 14 дней) в системных и пользовательских временных директориях, сохраняя актуальные данные. Поддерживает корпоративные среды и массовое применение.

## Основные возможности
- **Интеллектуальная очистка**: Автоматическое сохранение файлов младше 14 дней
- **Мультиметодный доступ**: Поддержка Admin Share, WMI и PowerShell Remoting
- **Два режима работы**: Интерактивный (с меню) и автоматический (для скриптов)
- **Исключение системных профилей**: Автоматический пропуск служебных учетных записей
- **Расширенное логирование**: Детальный журнал операций с ротацией логов
- **Кросс-версионная поддержка**: Совместимость с Windows 7/8/10/11 и Windows Server
- **Безопасное удаление**: Проверка прав доступа и корректности путей

## Требования
- **ОС**: Windows 7+ / Windows Server 2008 R2+
- **PowerShell**: Версия 3.0+
- **Права**: Локальные административные права
- **Для удаленного доступа**:
  - Доступ хотя бы к одному протоколу: Admin Share (порт 445), WMI (порт 135) или WinRM (порт 5985)
  - Сетевой доступ к целевым компьютерам

## Инструкция по использованию

### Базовый запуск
```powershell
powershell.exe -ExecutionPolicy Bypass -File "clear_temp.ps1"
```
(рекомендуется создать ярлык с параметрами: `C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -File "\\путь_к_скрипту\clear_temp.ps1"`)

### Параметры запуска
| Параметр        | Описание                                  | Пример использования                     |
|-----------------|-------------------------------------------|------------------------------------------|
| `-ComputerName` | Очистка на удаленном компьютере           | `.\clear_temp.ps1 -ComputerName WS-025` |
| `-AutoMode`     | Автоматический режим (без меню)           | `.\clear_temp.ps1 -AutoMode`            |
| `-Force`        | Принудительный запуск (с правами админа)  | `.\clear_temp.ps1 -Force`               |
| `-LogPath`      | Указание кастомного пути для логов        | `.\clear_temp.ps1 -LogPath "C:\Logs\clean.log"` |

### Примеры использования
```powershell
# Локальная очистка (интерактивный режим)
.\clear_temp.ps1

# Удаленная очистка в автоматическом режиме
.\clear_temp.ps1 -ComputerName WS-012 -AutoMode

# Массовая очистка списка компьютеров
"WS-011", "WS-012", "WS-013" | ForEach-Object {
    .\clear_temp.ps1 -ComputerName $_ -AutoMode
}
```

## Технические детали

### Очищаемые директории
1. **Системные временные файлы**  
   - `C:\Windows\Temp`
   - Удаляются файлы старше 14 дней

2. **Пользовательские временные файлы**  
   - `%USERPROFILE%\AppData\Local\Temp`
   - Очистка для всех несистемных профилей

3. **Резервные копии Sbis3Plugin**  
   - `%USERPROFILE%\AppData\Local\Sbis3Plugin\backup`
   - Специальная обработка для продуктов СБИС

### Исключаемые профили
Системные и служебные учетные записи пропускаются автоматически:
- systemprofile, service, defaultuser*
- public, Администратор, Administrator
- network*, localservice, networkservice

### Приоритет методов доступа
1. **Admin Share**  
   - Используется по умолчанию при доступности сетевых ресурсов (C$)
   - Не требует дополнительных настроек на целевых ПК

2. **PowerShell Remoting**  
   - Активируется при включенном WinRM
   - Требует предварительной настройки на целевых компьютерах

3. **WMI**  
   - Используется для получения информации о профилях
   - Не используется для непосредственного удаления файлов

### Логирование операций
- Автоматическая ротация логов (макс. размер 1 МБ)
- Цветная консольная индикация (INFO/SUCCESS/ERROR)
- Детальная информация по каждому удаленному файлу
- Раздельные логи для каждой операции очистки

## Важные примечания
1. Для работы через **PowerShell Remoting** должна быть включена соответствующая конфигурация:
   ```powershell
   Enable-PSRemoting -Force
   Set-NetFirewallRule -Name "WINRM-HTTP-In-TCP" -RemoteAddress Any
   ```

2. **Admin Share требования**:
   - Включенный доступ к административным ресурсам
   - Открытый порт 445 в файрволе
   - Сетевые политики, разрешающие доступ к C$

3. Особенности работы:
   - Скрипт автоматически перезапускается с правами администратора
   - При удаленном выполнении не затрагиваются открытые файлы
   - Рекомендуется выполнять во внерабочее время
   - Не требует перезагрузки компьютеров

## Поддержка
Для отчетов об ошибках или предложений по улучшению обращайтесь к разработчику.  
Copyright © 2025 Кодельник Максим Сергеевич | MIT License  
Версия: 2.1 (2025-08-04)
